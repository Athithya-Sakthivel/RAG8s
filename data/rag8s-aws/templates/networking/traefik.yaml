{{- /*
Traefik Deployment + Service
- Renders when .Values.network.traefik is present (chart-level default exists).
- Values-driven: image, replicas, service (type/ports/annotations), resources, nodeSelector, tolerations, affinity.
- Uses helpers for consistent labels.
- Guarded imagePullSecrets and optional configuration blocks.
*/ -}}
{{- $root := . -}}
{{- $t := .Values.network.traefik | default dict -}}
{{- $ns := default (default "networking" .Values.namespaces.networking) (include "rag8s.namespace" $root) -}}
{{- $svc := default dict $t.service -}}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik
  namespace: {{ $ns | quote }}
  labels:
{{ include "rag8s.labels" $root | indent 4 }}
    app.kubernetes.io/name: traefik
spec:
  replicas: {{ default 2 $t.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik
  template:
    metadata:
      labels:
        app.kubernetes.io/name: traefik
        {{- include "rag8s.labels" $root | nindent 8 }}
    spec:
      serviceAccountName: traefik
      {{- if $t.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml $t.imagePullSecrets | indent 8 }}
      {{- end }}
      containers:
        - name: traefik
          image: {{ default "traefik:v3.1" (printf "%s:%s" $t.image.repository $t.image.tag) | quote }}
          imagePullPolicy: {{ default "IfNotPresent" $t.image.pullPolicy }}
          args:
            - --api.insecure=true
            - --entryPoints.web.address=:8000
            - --entryPoints.websecure.address=:8443
            - --providers.kubernetescrd
          ports:
{{- $ports := default (list (dict "name" "web" "targetPort" 8000) (dict "name" "websecure" "targetPort" 8443)) $svc.ports }}
{{- range $p := $ports }}
            - name: {{ $p.name }}
              containerPort: {{ $p.targetPort }}
              protocol: TCP
{{- end }}
          resources:
{{ toYaml (default dict $t.resources) | indent 12 }}
      nodeSelector:
{{ toYaml (default dict $t.nodeSelector) | indent 8 }}
      tolerations:
{{ toYaml (default list $t.tolerations) | indent 8 }}
      affinity:
{{ toYaml (default dict $t.affinity) | indent 8 }}

---
apiVersion: v1
kind: Service
metadata:
  name: traefik
  namespace: {{ $ns | quote }}
  labels:
    app.kubernetes.io/name: traefik
    {{- include "rag8s.labels" $root | nindent 4 }}
  annotations:
{{- if $svc.annotations }}
{{ toYaml $svc.annotations | indent 4 }}
{{- else }}
{{- /* keep an empty block out if no annotations provided */ -}}
{{- end }}
spec:
  type: {{ default "LoadBalancer" $svc.type | quote }}
  selector:
    app.kubernetes.io/name: traefik
  ports:
{{ toYaml (default (list (dict "name" "web" "port" 80 "targetPort" 8000) (dict "name" "websecure" "port" 443 "targetPort" 8443)) $svc.ports) | indent 4 }}
