{{- /*
NetworkPolicy generator
- Renders only when .Values.network.policies.enabled is true.
- Accepts .Values.network.policies.rules as a list of rule objects.
- Each rule object shape (recommended):
  - name: my-policy
  - namespace: optional (defaults to values.namespaces.networking or release namespace)
  - podSelector: map (matchLabels / matchExpressions) or omitted â†’ selects all pods {}
  - policyTypes: optional list ["Ingress","Egress"]
  - ingress: optional list of ingress rules (each with from:[], ports:[])
  - egress: optional list of egress rules (each with to:[], ports:[])
  - labels: optional metadata.labels map to attach to the NP
- If policyTypes omitted, they are inferred from presence of ingress/egress.
- This template is intentionally *declarative*: it will not create any policy unless you configure it in values.
*/ -}}
{{- $root := . -}}
{{- $pol := $root.Values.network.policies | default dict -}}
{{- if not (default false $pol.enabled) -}}
{{- /* Network policies disabled: nothing to render */ -}}
{{- else -}}
{{- $rules := $pol.rules | default list -}}
{{- range $i, $r := $rules }}
{{- $ns := default (default $root.Values.namespaces.networking $r.namespace) (include "rag8s.namespace" $root) -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ default (printf "np-%d" $i) $r.name | quote }}
  namespace: {{ $ns | quote }}
  labels:
    app.kubernetes.io/name: {{ default (printf "np-%d" $i) $r.name | quote }}
    app.kubernetes.io/part-of: rag8s
    {{- include "rag8s.labels" $root | nindent 4 }}
    {{- if $r.labels }}
{{ toYaml $r.labels | indent 4 }}
    {{- end }}
spec:
  podSelector:
    {{- if $r.podSelector }}
{{ toYaml $r.podSelector | indent 4 }}
    {{- else }}
    {}
    {{- end }}
  {{- /* Determine policyTypes: explicit or inferred */ -}}
  {{- if $r.policyTypes }}
  policyTypes:
{{ toYaml $r.policyTypes | indent 4 }}
  {{- else }}
  policyTypes:
    {{- if $r.ingress }}
    - Ingress
    {{- end }}
    {{- if $r.egress }}
    - Egress
    {{- end }}
    {{- if and (not $r.ingress) (not $r.egress) }}
    - Ingress
    - Egress
    {{- end }}
  {{- end }}

  {{- if $r.ingress }}
  ingress:
{{ toYaml $r.ingress | indent 4 }}
  {{- end }}

  {{- if $r.egress }}
  egress:
{{ toYaml $r.egress | indent 4 }}
  {{- end }}
---
{{- end }}
{{- end }}
