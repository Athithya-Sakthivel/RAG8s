{{- /*
PodDisruptionBudgets for critical workloads.
Each PDB is rendered only when its corresponding .Values.core.pdb.<service>.enabled is true.
This template avoids nil-pointer dereferences by using safe locals and default patterns.
*/ -}}
{{- $vals := .Values -}}
{{- $namespaces := default (dict) $vals.namespaces -}}
{{- $core := default (dict) $vals.core -}}
{{- $pdb := default (dict) $core.pdb -}}

{{- $inferenceNS := default (default "inference" $namespaces.inference) (include "rag8s.namespace" .) -}}
{{- $vectorDbNS := default (default "vector-db" $namespaces.vectorDb) (include "rag8s.namespace" .) -}}

{{- /* Embedder + Reranker (Ray Serve) PDB */ -}}
{{- $embedder := default (dict) $pdb.embedderReranker -}}
{{- if default false $embedder.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: embedder-reranker-pdb
  namespace: {{ $inferenceNS | quote }}
spec:
  minAvailable: {{ default 1 $embedder.minAvailable }}
  selector:
    matchLabels:
{{ include "rag8s.selectorLabels" . | indent 6 }}
      app.kubernetes.io/name: embedder-reranker
{{- end }}

---
{{- /* SGLang (GPU LLM) PDB */ -}}
{{- $sglang := default (dict) $pdb.sglang -}}
{{- if default false $sglang.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: sglang-pdb
  namespace: {{ $inferenceNS | quote }}
spec:
  minAvailable: {{ default 1 $sglang.minAvailable }}
  selector:
    matchLabels:
{{ include "rag8s.selectorLabels" . | indent 6 }}
      app.kubernetes.io/name: sglang
{{- end }}

---
{{- /* Frontend PDB */ -}}
{{- $frontend := default (dict) $pdb.frontend -}}
{{- if default false $frontend.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: frontend-pdb
  namespace: {{ $inferenceNS | quote }}
spec:
  minAvailable: {{ default 1 $frontend.minAvailable }}
  selector:
    matchLabels:
{{ include "rag8s.selectorLabels" . | indent 6 }}
      app.kubernetes.io/component: frontend
{{- end }}

---
{{- /* Valkeye PDB (replaces Qdrant) */ -}}
{{- $valkeye := default (dict) $pdb.valkeye -}}
{{- if default false $valkeye.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: valkeye-pdb
  namespace: {{ .Release.Namespace | quote }}
spec:
  minAvailable: {{ default 1 $valkeye.minAvailable }}
  selector:
    matchLabels:
{{ include "rag8s.selectorLabels" . | indent 6 }}
      app: valkeye
{{- end }}

---
{{- /* ArangoDB PDB (stateful) */ -}}
{{- $arangodb := default (dict) $pdb.arangodb -}}
{{- if default false $arangodb.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: arangodb-pdb
  namespace: {{ $vectorDbNS | quote }}
spec:
  minAvailable: {{ default 1 $arangodb.minAvailable }}
  selector:
    matchLabels:
{{ include "rag8s.selectorLabels" . | indent 6 }}
      # Arango operator must propagate these labels to pods; if it doesn't, adjust selector to match operator pod labels.
      app.kubernetes.io/name: {{ include "rag8s.name" . | quote }}
{{- end }}
