
apiVersion: apps/v1
kind: Deployment
metadata:
  name: valkeye
  namespace: {{ .Release.Namespace }}
  labels:
    app: valkeye
spec:
  replicas: {{ .Values.valkey.pod.replicas }}
  selector:
    matchLabels:
      app: valkeye
  template:
    metadata:
      labels:
        app: valkeye
    spec:
      serviceAccountName: {{ .Values.valkey.serviceAccount }}
      containers:
        - name: valkeye
          image: "{{ .Values.valkey.image.repository }}:{{ .Values.valkey.image.tag }}"
          imagePullPolicy: {{ .Values.valkey.image.pullPolicy }}
          resources:
            requests:
              cpu: {{ .Values.valkey.resources.requests.cpu }}
              memory: {{ .Values.valkey.resources.requests.memory }}
            limits:
              cpu: {{ .Values.valkey.resources.limits.cpu }}
              memory: {{ .Values.valkey.resources.limits.memory }}
          env:
            - name: MAXMEMORY
              value: "{{ .Values.valkey.maxmemory }}"
            - name: APPENDONLY
              value: "{{ .Values.valkey.appendonly }}"
      nodeSelector:
{{ toYaml .Values.valkey.nodeSelector | indent 8 }}
      tolerations:
{{ toYaml .Values.valkey.tolerations | indent 8 }}
      affinity:
{{ toYaml .Values.valkey.affinity | indent 8 }}

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: valkeye-pdb
  namespace: {{ .Release.Namespace }}
spec:
  minAvailable: {{ .Values.core.pdb.valkey.minAvailable }}
  selector:
    matchLabels:
      app: valkeye
